<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <title>Multitasking</title>
    
    <link type="text/css" rel="stylesheet" href="../style/style.css">
  </head>

  <body>
    <div id="page" class="wide">
      <div class="container">
        <h2>Multitasking</h2>
	<p>Slogan supports executing multiple concurrent tasks. The <code>task</code> function takes a function as argument
	  and returns a new task object. <code>task_run</code> invokes that function in a new thread of control. Following 
	  is an example of a simple task for periodically printing a text message to the standard output stream:</p>
	<pre>
	  > var greeting = function () {
	                     println ("hello");
	                     task_sleep (2);
	                     greeting ()
	                   };
	  > var t = task (greeting);
	  > task_run (t);
	  > hello
	  hello
	  hello...</pre>
	<p>Running the thread causes the message "hello" to be printed every two seconds. <code>task_sleep</code> causes the
	  current task to wait for the specified number of seconds and then continue. The argument of this function can be
	  a decimal number to indicate sub-second timeouts. For example, the timeout <code>0.5</code> will cause the thread
	  to sleep for 500 milliseconds. To stop the running task, call <code>task_terminate</code> on it.</p>
	<p>Tasks can communicate with each other using messages. Any Slogan object can become a message for a task. 
	  Each task has an associated message queue where it receives messages from other threads. The following
	  examples shows a task that waits for a message to arrive in its message queue. The message is formatted as a pair.
	  The head of the pair points to the sender task and the tail is a string containing a Slogan program. The task
	  function parses and evaluates this Slogan program and returns the result to the sender.</p>
	<pre>
	  > var parser = function () {
	      let msg = task_receive ()
	      let sender = head (msg)
	      let code = tail (msg)
	      with_input_stream (!string, code,
	                         function (stream) {
			           let tokenizer = stream_tokenizer (stream, program = true)
	                           task_send (sender, eval (slogan (tokenizer)))
	                        });
	      parser ()
	  };

	  > var parser_task = task (parser);
	  > task_run (parser_task);

	  > var sender = function (program) {
	                   task_run (task (function () {
	                                     task_send (parser_task, [current_task() program]);
	                                     println (task_receive ());
                                             force_output ()
                                    }))
	    };

	  > sender ("10 + 20");
	  30
	  > sender ("function (x) { x * x } (100)"); 
	  1000</pre>
      </div>
    </div>
  </body>
</html>
